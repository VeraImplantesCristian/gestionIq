<!-- src/components/report-details/LogisticaTimeline.vue -->
<template>
  <div class="logistica-timeline-container">
    <!-- Estado de Carga -->
    <div v-if="isLoading" class="loading-state">Cargando controles de logística...</div>
    <!-- Estado de Error -->
    <div v-else-if="errorMsg" class="error-state">{{ errorMsg }}</div>
    
    <!-- Línea de Tiempo de Controles -->
    <ul v-else-if="logisticaControls.length > 0" class="timeline">
      <li v-for="control in logisticaControls" :key="control.id" class="timeline-item">
        <div class="timeline-dot" :class="getStatusColor(control.estado)"></div>
        <div class="timeline-content">
          <!-- Título y Fecha del Control -->
          <div class="timeline-header">
            <p class="timeline-title">Control de Devolución - Estado: <span class="font-bold">{{ control.estado.toUpperCase() }}</span></p>
            <time class="timeline-time">{{ formatDateTime(control.created_at) }}</time>
          </div>
          
          <!-- 
            COMENTARIO: INICIO DE LA MEJORA VISUAL
            Hemos reemplazado el simple <p> por un contenedor <div>.
            Esto nos permite añadir una etiqueta "Observaciones:" en negrita,
            dando contexto claro al texto que se muestra debajo.
            También hemos añadido un estilo para mejorar la presentación.
          -->
          <div v-if="control.observaciones" class="observaciones-wrapper">
            <strong>Observaciones:</strong>
            <p class="observaciones-texto">
              {{ control.observaciones }}
            </p>
          </div>
          <!-- FIN DE LA MEJORA VISUAL -->

          <!-- Visor de Evidencias -->
          <EvidenceViewer 
            v-if="control.photos && control.photos.length > 0"
            :files="control.photos" 
            class="mt-4"
          />
        </div>
      </li>
    </ul>

    <!-- Mensaje si no se encuentran controles -->
    <div v-else class="empty-state">
      <p>No se han registrado controles de logística para este reporte.</p>
    </div>
  </div>
</template>

<script setup>
import { ref, onMounted } from 'vue';
import { supabase } from '../../services/supabase';
import EvidenceViewer from '../shared/EvidenceViewer.vue';

const props = defineProps({
  reportId: { type: [String, Number], required: true },
});

const isLoading = ref(true);
const errorMsg = ref(null);
const logisticaControls = ref([]);
// COMENTARIO: Obtenemos la URL pública de R2 desde las variables de entorno.
const R2_PUBLIC_URL = import.meta.env.VITE_R2_PUBLIC_URL;

// COMENTARIO: Función para formatear la fecha y hora a un formato legible.
const formatDateTime = (dateString) => {
  if (!dateString) return 'N/A';
  return new Date(dateString).toLocaleString('es-AR', {
    day: '2-digit', 
    month: '2-digit', 
    year: 'numeric', 
    hour: '2-digit', 
    minute: '2-digit',
    timeZone: 'America/Argentina/Buenos_Aires'
  }) + ' hs';
};

// COMENTARIO: Asigna un color al punto de la línea de tiempo según el estado.
const getStatusColor = (status) => {
  if (status === 'ok') return 'bg-green-500';
  if (status === 'revision') return 'bg-yellow-500';
  if (status === 'problemas') return 'bg-red-500';
  return 'bg-gray-400';
};

// COMENTARIO: Función principal que carga los datos desde la vista de Supabase.
const fetchData = async () => {
  isLoading.value = true;
  errorMsg.value = null;

  try {
    // Llama a la vista 'logistica_controles_con_evidencias' que ya une los controles con sus fotos.
    const { data, error } = await supabase
      .from('logistica_controles_con_evidencias')
      .select('*')
      .eq('cirugia_id', props.reportId)
      .order('created_at', { ascending: false });

    if (error) throw error;

    // Procesa los datos recibidos para construir las URLs completas de las imágenes.
    const processedData = (data || []).map(control => {
      const processedPhotos = (control.photos || []).map(photo => ({
        ...photo,
        url: `${R2_PUBLIC_URL}/${photo.object_key}`, // Construye la URL pública.
        caption: photo.file_name
      }));
      return { ...control, photos: processedPhotos };
    });

    logisticaControls.value = processedData;

  } catch (error) {
    console.error("Error cargando datos de logística:", error);
    errorMsg.value = "No se pudo cargar la información de logística.";
  } finally {
    isLoading.value = false;
  }
};

// COMENTARIO: Llama a fetchData() cuando el componente se monta en el DOM.
onMounted(fetchData);
</script>

<style scoped>
.loading-state, .error-state, .empty-state { text-align: center; padding: 2rem; color: #64748b; }
.error-state { color: #dc2626; }
.empty-state { font-size: 0.875rem; border: 1px dashed #e2e8f0; border-radius: 8px; }
.timeline { list-style: none; padding: 0; position: relative; }
.timeline::before { content: ''; position: absolute; top: 5px; left: 5px; bottom: 5px; width: 2px; background-color: #e2e8f0; }
.timeline-item { position: relative; padding-left: 2rem; margin-bottom: 2rem; }
.timeline-dot { position: absolute; left: 0; top: 5px; width: 12px; height: 12px; border-radius: 50%; border: 2px solid white; }
.timeline-header { display: flex; justify-content: space-between; align-items: baseline; }
.timeline-title { font-weight: 600; color: #334155; }
.timeline-time { font-size: 0.75rem; color: #94a3b8; }
.bg-green-500 { background-color: #22c55e; }
.bg-yellow-500 { background-color: #f59e0b; }
.bg-red-500 { background-color: #ef4444; }
.bg-gray-400 { background-color: #9ca3af; }

/* COMENTARIO: INICIO DE NUEVOS ESTILOS */
.observaciones-wrapper {
  margin-top: 0.75rem; /* 12px */
  padding: 0.75rem; /* 12px */
  background-color: #f8fafc; /* bg-slate-50 */
  border-left: 3px solid #cbd5e1; /* border-slate-300 */
  border-radius: 4px;
}
.observaciones-wrapper strong {
  font-size: 0.875rem; /* 14px */
  color: #475569; /* text-slate-600 */
}
.observaciones-texto {
  font-size: 0.875rem; /* 14px */
  color: #64748b; /* text-slate-500 */
  margin-top: 0.25rem; /* 4px */
  white-space: pre-wrap; /* Respeta saltos de línea y espacios */
}
/* FIN DE NUEVOS ESTILOS */
</style>