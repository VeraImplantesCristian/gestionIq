create table public.reportes (
  id bigint generated by default as identity not null,
  cliente text null,
  paciente text not null,
  medico text not null,
  instrumentador text null,
  lugar_cirugia text null,
  fecha_cirugia date null,
  tipo_cirugia text null,
  material text null,
  observaciones text null,
  info_adicional text null,
  estado text not null default 'pendientes'::text,
  created_at timestamp with time zone not null default now(),
  token uuid null,
  set_completo boolean null,
  informe_faltante boolean null,
  rating_puntualidad smallint null,
  rating_condiciones smallint null,
  rating_asesoramiento smallint null,
  rating_evaluacion_general smallint null,
  representante_ventas text null,
  tipo_logistica text null,
  transporte_utilizado text null,
  acepta_terminos boolean null default false,
  instrumentador_completado text null,
  url_firma text null,
  consumo_realizado text null,
  fecha_envio date null,
  email_cliente text null,
  mensaje_inicio text null,
  id_cirugia text not null default (
    'CX-'::text || (nextval('reportes_id_cirugia_seq'::regclass))::text
  ),
  duracion_cirugia text null,
  instrumentador_dni text null,
  puntaje_iq numeric null,
  clasificacion_cirugia text null,
  estado_pago text null default 'Pendiente'::text,
  pago_id bigint null,
  monto_a_pagar numeric null default 0,
  constraint reportes_pkey primary key (id),
  constraint reportes_id_cirugia_key unique (id_cirugia),
  constraint reportes_token_key unique (token),
  constraint fk_instrumentador_dni foreign KEY (instrumentador_dni) references instrumentadores (dni),
  constraint reportes_pago_id_fkey foreign KEY (pago_id) references pagos (id),
  constraint chk_asesoramiento check (
    (
      (rating_asesoramiento >= 1)
      and (rating_asesoramiento <= 5)
    )
  ),
  constraint reportes_estado_check check (
    (
      estado = any (
        array[
          'Pendiente'::text,
          'Enviado'::text,
          'Expirado'::text
        ]
      )
    )
  ),
  constraint chk_evaluacion_general check (
    (
      (rating_evaluacion_general >= 1)
      and (rating_evaluacion_general <= 5)
    )
  ),
  constraint chk_condiciones check (
    (
      (rating_condiciones >= 1)
      and (rating_condiciones <= 5)
    )
  ),
  constraint chk_estado_pago check (
    (
      estado_pago = any (array['Pendiente'::text, 'Pagado'::text])
    )
  ),
  constraint chk_puntualidad check (
    (
      (rating_puntualidad >= 1)
      and (rating_puntualidad <= 5)
    )
  )
) TABLESPACE pg_default;

create trigger on_ficha_enviada_create_notification
after
update on reportes for EACH row when (
  old.estado is distinct from new.estado
  and new.estado = 'Enviado'::text
)
execute FUNCTION handle_new_notification_on_ficha_enviada ();

create trigger trigger_calculate_puntaje_iq_on_update BEFORE
update on reportes for EACH row when (
  old.estado is distinct from 'Enviado'::text
  and new.estado = 'Enviado'::text
)
execute FUNCTION calculate_puntaje_iq ();