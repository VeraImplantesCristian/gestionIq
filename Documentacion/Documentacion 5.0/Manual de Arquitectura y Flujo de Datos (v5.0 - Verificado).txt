INICIO DEL ARCHIVO: Manual de Arquitectura y Flujo de Datos (v5.0 - Verificado).txt

Este documento detalla el rol de cada componente del ecosistema "Gestion IQ" y el flujo de informaci贸n entre ellos. Reemplaza todas las versiones anteriores.

1. FILOSOFA ARQUITECTNICA: "SERVER-CENTRIC" CON CLIENTE INTELIGENTE
La l贸gica de negocio cr铆tica reside en Supabase (PostgreSQL). El frontend (Vue 3) act煤a como un cliente que consume datos a trav茅s de RPCs, orquesta la UI y gestiona el estado local.

2. FLUJO DE VIDA DE LA INFORMACIN (Perspectiva del Usuario)

2.1. El Instrumentador (Portal de Actividad Mejorado)

*   **Acceso al Portal (Flujo Verificado):**
    1.  El instrumentador accede a su link 煤nico (ej. `.../resumen/{token}`).
    2.  La vista `ActivitySummaryView.vue` le solicita su DNI.
    3.  Al enviar, se llama a la RPC `autenticar_y_obtener_resumen`. El backend realiza una comparaci贸n robusta (insensible a puntos o espacios) del token y el DNI.
    4.  Si la autenticaci贸n es exitosa, el backend devuelve un objeto JSON con los datos personales y el historial de actividad.

*   **Visualizaci贸n de Pagos (Dise帽o Actualizado):**
    1.  La vista `ActivitySummaryView.vue` ahora presenta las cirug铆as en dos bloques separados: "Pendientes de Pago" e "Hist贸rico de Pagos".
    2.  **Cirug铆as Pendientes:** Muestran el estado "A la espera de lote de pago".
    3.  **Cirug铆as Pagadas:** Se agrupan por mes de pago. Cada tarjeta muestra la fecha de pago y dos acciones:
        *   **"Ver Detalles":** Abre un modal (`PaymentDetailModal.vue`) con un resumen simple del pago (monto, fecha, Orden de Pago asociada).
        *   **"Ver Comprobante":** Abre el archivo del comprobante general de la orden de pago en una nueva pesta帽a.

*   **Consulta de Datos Personales (NUEVO):**
    1.  Una nueva pesta帽a "Mis Datos" muestra la informaci贸n personal y de pago (`nombre`, `cuil`, `cbu`, etc.) que el sistema tiene registrada.

*   **Canal de Comunicaci贸n (NUEVO):**
    1.  Un bot贸n flotante de WhatsApp ofrece un enlace directo para iniciar una conversaci贸n con "Gesti贸n de Pagos (Cesar)".

2.2. El Administrador (Panel de Control con Inteligencia Operativa)

*   **Gesti贸n de Instrumentadores (Flujo Actualizado con IVO):**
    1.  La vista `InstrumentadoresView.vue` ahora muestra una tabla simplificada con el **"IVO (90d)"** como m茅trica principal de rendimiento.
    2.  Las columnas de promedios manuales y digitales han sido eliminadas.
    3.  Un panel de filtros (`InstrumentadoresFilters.vue`) permite buscar, ordenar por IVO y exportar los datos a Excel.
    4.  Un bot贸n "Ver Estad铆sticas" en cada fila abre un modal (`EstadisticasInstrumentadorModal.vue`) que presenta un an谩lisis detallado del rendimiento del instrumentador, incluyendo:
        *   Su categor铆a de rendimiento (Destacado, Correcto, etc.).
        *   Un gr谩fico de barras que desglosa la composici贸n de su puntaje.
        *   El impacto de las penalizaciones por incidencias.
        *   El conteo de "Intervenciones Clave" registradas.

*   **Gesti贸n de Incidencias e Intervenciones Clave (Flujo Actualizado):**
    1.  El administrador sigue usando el `NewIncidenceModal.vue` para registrar eventos.
    2.  Un nuevo checkbox **"Marcar como Intervenci贸n Clave"** permite clasificar un evento como un aporte excepcional.
    3.  Si se marca, el registro se guarda como una incidencia pero con `es_intervencion_clave = true`, lo que evita que penalice el IVO del instrumentador.
    4.  La tabla de `IncidenciasView.vue` muestra un indicador "" para identificar visualmente estas intervenciones.

*   **Flujo de Pagos por Lote:** (Sin cambios funcionales). El administrador sigue utilizando el `PagosDashboardView.vue` y `CrearOrdenDePagoView.vue` para generar y registrar las 贸rdenes de pago.

3. INTERACCIONES DETALLADAS CON LA BASE DE DATOS (Rol 'anon')

*   `rpc('autenticar_y_obtener_resumen', { p_token, p_dni })`:
    *   **Rol:** nica llamada a la base de datos que realiza el portal del instrumentador.
    *   **Respuesta Esperada (ACTUALIZADO):** Un objeto JSON `{ instrumentador_info: {...}, activity_summary: [...] }`. El frontend est谩 preparado para manejar esta estructura.